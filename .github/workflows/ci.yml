name: Continuous Integration

on:
  workflow_dispatch:
  merge_group:
  pull_request:
  push:
    branches:
      - main

concurrency:
  # This causes the workflow to be cancelled if a newer commit is pushed to the
  # pull request while it's still being built. Builds on main are not cancelled.
  group: ${{ github.workflow }}-${{ github.ref == 'refs/heads/main' && github.run_id || github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  # # Validate changesets - handles both general and Rust-specific validation
  # validate-changesets:
  #   name: âœï¸ Validate Changesets
  #   runs-on: ubuntu-24.04
  #   if: github.ref_name != 'main'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const { validateChangesets } = require('./scripts/validate-changesets.js');
  #           await validateChangesets({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             pullNumber: context.payload.pull_request.number,
  #             octokit: github
  #           });

  # Build and store native packages (Linux)
  build_native_linux:
    name: ðŸ¥ Build Linux AMD64
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: ./.github/actions/rust-toolchain
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'x86_64-unknown-linux-gnu'
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Run sccache stat for check
        shell: bash
        run: ${SCCACHE_PATH} --show-stats
      - uses: ./.github/actions/setup-node
      - name: Free up space
        run: |
          sudo rm -rf /usr/local/lib/android || true
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*'
      - env:
          RUSTUP_TARGET: x86_64-unknown-linux-gnu
          CARGO_PROFILE: release
          SCCACHE_GHA_ENABLED: 'true'
          RUSTC_WRAPPER: 'sccache'
        run: yarn build-native
      - run: yarn build:ci
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-x86_64-unknown-linux-gnu
          path: packages/**/*
          retention-days: 1

  # Build and store native packages (macOS)
  build_native_macos:
    name: ðŸŽ Build MacOS ARM64
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: ./.github/actions/rust-toolchain
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'aarch64-apple-darwin'
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Run sccache stat for check
        shell: bash
        run: ${SCCACHE_PATH} --show-stats
      - uses: ./.github/actions/setup-node
      - env:
          RUSTUP_TARGET: aarch64-apple-darwin
          CARGO_PROFILE: release
          SCCACHE_GHA_ENABLED: 'true'
          RUSTC_WRAPPER: 'sccache'
        run: yarn build-native
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-aarch64-apple-darwin
          path: packages/**/*
          retention-days: 1

  # lint_javascript:
  #   name: ðŸ”Ž Lint TypeScript
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #     - run: npx eslint .
  #     - run: npx prettier --list-different .

  # check_typescript:
  #   name: ðŸ“‹ Check TypeScript
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #     - run: yarn build:ts

  # lint_feature_flags:
  #   name: ðŸ´â€â˜ ï¸ Lint Feature Flags
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #     - run: yarn lint:feature-flags

  # lint_rust:
  #   name: ðŸ¦€ Lint Rust
  #   runs-on: ubuntu-24.04
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Rust
  #       uses: ./.github/actions/rust-toolchain
  #       with: {components: 'clippy, rustfmt'}
  #     - run: cargo fmt --all -- --check
  #     - run: cargo clippy -- -D warnings

  # unit_tests_rust:
  #   strategy:
  #     matrix:
  #       include:
  #         - os: ubuntu-22.04
  #         - os: macos-15
  #   name: Unit tests (${{ matrix.os }}, Rust)
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Rust
  #       uses: ./.github/actions/rust-toolchain
  #     - uses: Swatinem/rust-cache@v2
  #       with:
  #         shared-key: '${{ matrix.os }}-rust-unit-tests'
  #         # Only store new caches on main
  #         save-if: ${{ github.ref == 'refs/heads/main' }}
  #
  #     - name: Free up space
  #       if: ${{ runner.os == 'Linux' }}
  #       run: |
  #         sudo rm -rf /usr/local/lib/android || true
  #         sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*'
  #     - run: cargo test

  # unit_tests:
  #   name: Unit tests (${{ matrix.os }}, Node ${{ matrix.node }})
  #   needs:
  #     - build_native
  #   strategy:
  #     matrix:
  #       os: ['ubuntu-22.04', 'macos-15']
  #       node: [24]
  #       exclude:
  #         # Seems to have an error - in theory we have enough coverage with the other tests / variations
  #         - os: macos-15
  #           node: 24
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #       with:
  #         node-version: ${{ matrix.node }}
  #     - uses: actions/download-artifact@v4
  #       with:
  #         pattern: packages-*
  #         path: packages
  #         merge-multiple: true
  #     - name: Bump max inotify watches (Linux only)
  #       if: ${{ runner.os == 'Linux' }}
  #       run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
  #     - run: yarn test:js:unit

  integration_tests_linux:
    name: Integration tests (ubuntu-22.04, Node 24, Slice ${{ matrix.slice_num }}/${{ matrix.slice_total }})
    needs:
      - build_native_linux
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        slice_num: [1, 2, 3, 4]
        slice_total: [4]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-watchman
      - uses: ./.github/actions/setup-node
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: packages-x86_64-unknown-linux-gnu
          path: packages
      - name: Bump max inotify watches
        run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
      - name: Start resource monitor
        run: |
          # Log memory and disk usage every 30s in the background
          (while true; do
            echo "--- $(date -u '+%Y-%m-%dT%H:%M:%SZ') ---"
            free -m
            df -h /
            echo ""
            sleep 30
          done) > /tmp/resource-monitor.log 2>&1 &
          echo $! > /tmp/resource-monitor.pid
      - run: yarn test:integration-ci
        env:
          SLICE_NUM: ${{ matrix.slice_num }}
          SLICE_TOTAL: ${{ matrix.slice_total }}
          ATLASPACK_MOCHA_HANG_DEBUG: 'true'
          RUST_BACKTRACE: full
      - name: Upload resource monitor log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resource-log-ubuntu-22.04-node24-slice${{ matrix.slice_num }}
          path: /tmp/resource-monitor.log
          if-no-files-found: ignore
          retention-days: 3

  integration_tests_macos:
    name: Integration tests (macos-15, Node 24, Slice ${{ matrix.slice_num }}/${{ matrix.slice_total }})
    needs:
      - build_native_macos
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        slice_num: [1, 2, 3, 4]
        slice_total: [4]
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-watchman
      - uses: ./.github/actions/setup-node
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: packages-aarch64-apple-darwin
          path: packages
      - name: Start resource monitor
        run: |
          # Log memory and disk usage every 30s in the background
          (while true; do
            echo "--- $(date -u '+%Y-%m-%dT%H:%M:%SZ') ---"
            vm_stat | head -10
            df -h /
            echo ""
            sleep 30
          done) > /tmp/resource-monitor.log 2>&1 &
          echo $! > /tmp/resource-monitor.pid
      - run: yarn test:integration-ci
        env:
          SLICE_NUM: ${{ matrix.slice_num }}
          SLICE_TOTAL: ${{ matrix.slice_total }}
          ATLASPACK_MOCHA_HANG_DEBUG: 'true'
          RUST_BACKTRACE: full
      - name: Upload resource monitor log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resource-log-macos-15-node24-slice${{ matrix.slice_num }}
          path: /tmp/resource-monitor.log
          if-no-files-found: ignore
          retention-days: 3

  integration_tests_v3_linux:
    name: Integration tests (v3 ubuntu-22.04, Node 24, Slice ${{ matrix.slice_num }}/${{ matrix.slice_total }})
    needs:
      - build_native_linux
    timeout-minutes: 25
    strategy:
      # These tend to be quite flakey, so one failed instance shouldn't stop
      # others from potentially succeeding
      fail-fast: false
      matrix:
        slice_num: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]
        slice_total: [16]
    runs-on: ubuntu-22.04
    steps:
      - name: Collect Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@v2
        with:
          comment_on_pr: false
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-watchman
      - uses: ./.github/actions/setup-node
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: packages-x86_64-unknown-linux-gnu
          path: packages
      - name: Bump max inotify watches
        run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
      - name: Enable core dumps
        run: |
          # Enable core dumps
          ulimit -c unlimited
          # Set core dump pattern to put dumps in /tmp with identifying info
          echo '/tmp/core.%e.%p.%t' | sudo tee /proc/sys/kernel/core_pattern
          # Create directory for core dumps
          sudo mkdir -p /tmp
          sudo chmod 777 /tmp
          echo "Core dumps enabled. Pattern: $(cat /proc/sys/kernel/core_pattern)"
      - name: Start resource monitor
        run: |
          # Log memory and disk usage every 30s in the background
          (while true; do
            echo "--- $(date -u '+%Y-%m-%dT%H:%M:%SZ') ---"
            free -m
            df -h /
            echo ""
            sleep 30
          done) > /tmp/resource-monitor.log 2>&1 &
          echo $! > /tmp/resource-monitor.pid
      - run: yarn test:integration-ci
        env:
          ATLASPACK_V3: true
          SLICE_NUM: ${{ matrix.slice_num }}
          SLICE_TOTAL: ${{ matrix.slice_total }}
          ATLASPACK_MOCHA_HANG_DEBUG: 'true'
          ISOLATE_TESTS: 'false'
          RUST_BACKTRACE: full
      - name: Upload resource monitor log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resource-log-v3-ubuntu-22.04-node24-slice${{ matrix.slice_num }}
          path: /tmp/resource-monitor.log
          if-no-files-found: ignore
          retention-days: 3
      - name: Collect core dumps
        if: always()
        run: |
          echo "Looking for core dumps in /tmp..."
          if ls /tmp/core.* 1> /dev/null 2>&1; then
            echo "Core dumps found:"
            ls -lh /tmp/core.*
            mkdir -p core-dumps
            cp /tmp/core.* core-dumps/ || true
          else
            echo "No core dumps found"
          fi
      - name: Upload core dumps
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-dumps-v3-ubuntu-22.04-node-24-${{ github.run_id }}
          path: core-dumps/
          if-no-files-found: ignore
          retention-days: 7

  integration_tests_v3_macos:
    name: Integration tests (v3 macos-15, Node 24, Slice ${{ matrix.slice_num }}/${{ matrix.slice_total }})
    needs:
      - build_native_macos
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        slice_num: [1, 2, 3, 4]
        slice_total: [4]
    runs-on: macos-15
    steps:
      - name: Collect Workflow Telemetry
        uses: catchpoint/workflow-telemetry-action@v2
        with:
          comment_on_pr: false
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-watchman
      - uses: ./.github/actions/setup-node
        with:
          node-version: 24
      - uses: actions/download-artifact@v4
        with:
          name: packages-aarch64-apple-darwin
          path: packages
      - name: Start resource monitor
        run: |
          # Log memory and disk usage every 30s in the background
          (while true; do
            echo "--- $(date -u '+%Y-%m-%dT%H:%M:%SZ') ---"
            vm_stat | head -10
            df -h /
            echo ""
            sleep 30
          done) > /tmp/resource-monitor.log 2>&1 &
          echo $! > /tmp/resource-monitor.pid
      - run: yarn test:integration-ci
        env:
          ATLASPACK_V3: true
          SLICE_NUM: ${{ matrix.slice_num }}
          SLICE_TOTAL: ${{ matrix.slice_total }}
          ATLASPACK_MOCHA_HANG_DEBUG: 'true'
          ISOLATE_TESTS: 'false'
          RUST_BACKTRACE: full
      - name: Upload resource monitor log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resource-log-v3-macos-15-node24-slice${{ matrix.slice_num }}
          path: /tmp/resource-monitor.log
          if-no-files-found: ignore
          retention-days: 3

  # end_to_end_tests:
  #   name: E2E tests
  #   needs:
  #     - build_native
  #   timeout-minutes: 35
  #   strategy:
  #     matrix:
  #       node: [24]
  #       os: [ubuntu-latest]
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #       with:
  #         node-version: ${{ matrix.node }}
  #     - uses: actions/download-artifact@v4
  #       with:
  #         pattern: packages-*
  #         path: packages
  #         merge-multiple: true
  #     - name: Bump max inotify watches (Linux only)
  #       run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
  #       if: ${{ runner.os == 'Linux' }}
  #     - run: yarn playwright install
  #     - run: yarn test:e2e:ci

  # atlaspack_inspector_unit_tests:
  #   name: ${{ matrix.project }} - Unit tests (${{ matrix.os }}, Node ${{ matrix.node }})
  #   needs:
  #     - build_native
  #   strategy:
  #     matrix:
  #       node: [24]
  #       os: ['ubuntu-22.04']
  #       project: ['@atlaspack/inspector', '@atlaspack/inspector-frontend']
  #
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #       with:
  #         node-version: ${{ matrix.node }}
  #     - uses: actions/download-artifact@v4
  #       with:
  #         pattern: packages-*
  #         path: packages
  #         merge-multiple: true
  #     - name: Bump max inotify watches (Linux only)
  #       if: ${{ runner.os == 'Linux' }}
  #       run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
  #     - run: |
  #         yarn build
  #         yarn workspace ${{ matrix.project }} test:unit

  # atlaspack_inspector_e2e_tests:
  #   name: '@atlaspack/inspector - E2E tests (${{ matrix.os }}, Node ${{ matrix.node }})'
  #   needs:
  #     - build_native
  #   strategy:
  #     matrix:
  #       node: [24]
  #       os: ['ubuntu-22.04']
  #
  #   runs-on: ${{ matrix.os }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: ./.github/actions/setup-node
  #       with:
  #         node-version: ${{ matrix.node }}
  #     - uses: actions/download-artifact@v4
  #       with:
  #         pattern: packages-*
  #         path: packages
  #         merge-multiple: true
  #     - name: Bump max inotify watches (Linux only)
  #       if: ${{ runner.os == 'Linux' }}
  #       run: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p;
  #     - run: |
  #         yarn build
  #         yarn playwright install-deps
  #         yarn playwright install
  #         yarn workspace @atlaspack/inspector test:e2e
